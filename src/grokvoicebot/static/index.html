<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grok ITSD Web Voicebot</title>
    <style>
      :root { --bg:#0b1020; --panel:#141b34; --text:#eaf0ff; --muted:#a8b3d1; --accent:#5aa8ff; }
      body { margin:0; font-family:Inter,system-ui,Arial,sans-serif; background:linear-gradient(120deg,#0b1020,#131d3c 65%); color:var(--text); }
      .container { max-width:1100px; margin:24px auto; padding:0 16px; }
      .grid { display:grid; gap:14px; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); }
      .card { background:rgba(20,27,52,.85); border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:14px; }
      .muted { color:var(--muted); }
      label { display:block; font-size:12px; margin-top:10px; color:var(--muted); }
      input, textarea, select, button { width:100%; box-sizing:border-box; border-radius:8px; border:1px solid #32406f; background:#0f1730; color:var(--text); padding:10px; }
      textarea { min-height:90px; }
      button { margin-top:10px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:600; }
      button.secondary { background:#334a86; }
      #chatLog { min-height:220px; max-height:380px; overflow:auto; background:#080d1f; border:1px solid #2c3862; border-radius:10px; padding:10px; }
      .msg { margin:8px 0; padding:8px; border-radius:8px; }
      .user { background:#1f2d54; }
      .bot { background:#163729; }
      #output { margin-top:16px; white-space:pre-wrap; background:#080d1f; border:1px solid #2c3862; border-radius:12px; padding:12px; min-height:120px; }
      .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#20315b; color:#b9ccff; font-size:12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ITSD Web Voicebot</h1>
      <p class="muted">Webpage-based voicebot for ticketing and troubleshooting knowledge retrieval.</p>
      <span class="pill">Route: <code>/assistant/respond</code></span>

      <div class="grid" style="margin-top: 12px;">
        <section class="card">
          <h3>üó£Ô∏è Voicebot Conversation</h3>
          <p class="muted">Click start, speak, then send to the assistant. Bot replies are also spoken using browser TTS.</p>
          <button id="startVoice">Start Listening</button>
          <div class="muted" id="voiceStatus">Idle</div>
          <label>Recognized utterance</label>
          <textarea id="recognizedText" placeholder="e.g. create ticket for vpn not working"></textarea>
          <button id="sendToBot">Send to Voicebot</button>
          <label>Conversation</label>
          <div id="chatLog"></div>
        </section>

        <section class="card">
          <h3>üß™ Direct API Testing</h3>
          <p class="muted">Keep direct endpoint testing for troubleshooting.</p>
          <label>Knowledge query</label>
          <input id="knowledgeQuery" placeholder="vpn" />
          <button class="secondary" onclick="searchKnowledge()">Search Knowledge</button>

          <label>Ticket status ID</label>
          <input id="statusTicketId" type="number" placeholder="1" />
          <button class="secondary" onclick="getStatus()">Get Ticket Status</button>

          <label>Raw output</label>
          <div id="output">Ready</div>
        </section>
      </div>
    </div>

    <script>
      const output = document.getElementById('output');
      const voiceStatus = document.getElementById('voiceStatus');
      const recognizedText = document.getElementById('recognizedText');
      const chatLog = document.getElementById('chatLog');

      function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.textContent = `${role === 'user' ? 'You' : 'Voicebot'}: ${text}`;
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function speak(text) {
        if (!('speechSynthesis' in window)) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'en-US';
        window.speechSynthesis.speak(utter);
      }

      function log(data) {
        const stamp = new Date().toLocaleTimeString();
        output.textContent = `[${stamp}]\n` + JSON.stringify(data, null, 2);
      }

      async function postJson(url, payload) {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        return res.json();
      }

      async function sendToVoicebot() {
        const utterance = recognizedText.value.trim();
        if (!utterance) return;
        appendMessage('user', utterance);
        const data = await postJson('/assistant/respond', { utterance });
        log(data);
        if (data.response) {
          appendMessage('bot', data.response);
          speak(data.response);
        }
      }

      async function searchKnowledge() {
        log(await postJson('/knowledge/search', { query: document.getElementById('knowledgeQuery').value }));
      }

      async function getStatus() {
        log(await postJson('/tickets/status', { ticket_id: Number(document.getElementById('statusTicketId').value) }));
      }

      document.getElementById('sendToBot').addEventListener('click', sendToVoicebot);

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onstart = () => { voiceStatus.textContent = 'Listening...'; };
        recognition.onend = () => { voiceStatus.textContent = 'Idle'; };
        recognition.onerror = (e) => { voiceStatus.textContent = `Error: ${e.error}`; };
        recognition.onresult = (event) => {
          recognizedText.value = event.results[0][0].transcript;
          voiceStatus.textContent = 'Captured. Click Send to Voicebot';
        };

        document.getElementById('startVoice').addEventListener('click', () => recognition.start());
      } else {
        document.getElementById('startVoice').disabled = true;
        voiceStatus.textContent = 'SpeechRecognition not supported in this browser.';
      }
    </script>
  </body>
</html>
